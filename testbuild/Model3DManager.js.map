{
  "version": 3,
  "sources": ["../../../../../GDJS/Runtime/Model3DManager.ts"],
  "sourcesContent": ["/*\n * GDevelop JS Platform\n * Copyright 2013-present Florian Rival (Florian.Rival@gmail.com). All rights reserved.\n * This project is released under the MIT License.\n */\nnamespace gdjs {\n  const logger = new gdjs.Logger('Model3DManager');\n  type OnProgressCallback = (loadedCount: integer, totalCount: integer) => void;\n  type OnCompleteCallback = (totalCount: integer) => void;\n\n  /**\n   * Load GLB files (using `Three.js`), using the \"model3D\" resources\n   * registered in the game resources.\n   */\n  export class Model3DManager {\n    /**\n     * Map associating a resource name to the loaded Three.js model.\n     */\n    private _loadedThreeModels = new Map<String, THREE_ADDONS.GLTF>();\n\n    _resourcesLoader: RuntimeGameResourcesLoader;\n    _resources: ResourceData[];\n\n    _loader: THREE_ADDONS.GLTFLoader | null = null;\n    _dracoLoader: THREE_ADDONS.DRACOLoader | null = null;\n\n    //@ts-ignore Can only be null if THREE is not loaded.\n    _invalidModel: THREE_ADDONS.GLTF;\n\n    /**\n     * @param resources The resources data of the game.\n     * @param resourcesLoader The resources loader of the game.\n     */\n    constructor(\n      resources: ResourceData[],\n      resourcesLoader: RuntimeGameResourcesLoader\n    ) {\n      this._resources = resources;\n      this._resourcesLoader = resourcesLoader;\n\n      if (typeof THREE !== 'undefined') {\n        this._loader = new THREE_ADDONS.GLTFLoader();\n\n        this._dracoLoader = new THREE_ADDONS.DRACOLoader();\n        this._dracoLoader.setDecoderPath('./pixi-renderers/draco/gltf/');\n        this._loader.setDRACOLoader(this._dracoLoader);\n\n        /**\n         * The invalid model is a box with magenta (#ff00ff) faces, to be\n         * easily spotted if rendered on screen.\n         */\n        const group = new THREE.Group();\n        group.add(\n          new THREE.Mesh(\n            new THREE.BoxGeometry(1, 1, 1),\n            new THREE.MeshBasicMaterial({ color: '#ff00ff' })\n          )\n        );\n        this._invalidModel = {\n          scene: group,\n          animations: [],\n          cameras: [],\n          scenes: [],\n          asset: {},\n          userData: {},\n          //@ts-ignore\n          parser: null,\n        };\n      }\n    }\n\n    /**\n     * Update the resources data of the game. Useful for hot-reloading, should not be used otherwise.\n     *\n     * @param resources The resources data of the game.\n     */\n    setResources(resources: ResourceData[]): void {\n      this._resources = resources;\n    }\n\n    /**\n     * Load all the 3D models.\n     *\n     * Note that even if a file is already loaded, it will be reloaded (useful for hot-reloading,\n     * as files can have been modified without the editor knowing).\n     *\n     * @param onProgress The function called after each file is loaded.\n     * @param onComplete The function called when all file are loaded.\n     */\n    loadModels(\n      onProgress: OnProgressCallback,\n      onComplete: OnCompleteCallback\n    ): void {\n      const resources = this._resources;\n      const model3DResources = resources.filter(function (resource) {\n        return resource.kind === 'model3D';\n      });\n      if (model3DResources.length === 0 || !this._loader) {\n        return onComplete(model3DResources.length);\n      }\n\n      let loaded = 0;\n      for (let i = 0; i < model3DResources.length; ++i) {\n        const resource = model3DResources[i];\n        const url = this._resourcesLoader.getFullUrl(resource.file);\n\n        this._loader.withCredentials = this._resourcesLoader.checkIfCredentialsRequired(\n          url\n        );\n        this._loader.load(\n          url,\n          (gltf: THREE_ADDONS.GLTF) => {\n            this._loadedThreeModels.set(resource.name, gltf);\n\n            loaded++;\n            if (loaded === model3DResources.length) {\n              onComplete(model3DResources.length);\n            } else {\n              onProgress(loaded, model3DResources.length);\n            }\n          },\n          undefined,\n          (error) => {\n            logger.error(error);\n\n            loaded++;\n            if (loaded === model3DResources.length) {\n              onComplete(model3DResources.length);\n            } else {\n              onProgress(loaded, model3DResources.length);\n            }\n          }\n        );\n      }\n    }\n\n    /**\n     * Return a 3D model.\n     *\n     * Caller should not modify the object but clone it.\n     *\n     * @param resourceName The name of the json resource.\n     * @returns a 3D model if it exists.\n     */\n    getModel(resourceName: string): THREE_ADDONS.GLTF {\n      return this._loadedThreeModels.get(resourceName) || this._invalidModel;\n    }\n  }\n}\n"],
  "mappings": "AAKA,GAAU,MAAV,UAAU,EAAV,CACE,KAAM,GAAS,GAAI,GAAK,OAAO,kBAQxB,OAAqB,CAmB1B,YACE,EACA,EACA,CAlBM,wBAAqB,GAAI,KAKjC,aAA0C,KAC1C,kBAAgD,KAgB9C,GAHA,KAAK,WAAa,EAClB,KAAK,iBAAmB,EAEpB,MAAO,QAAU,YAAa,CAChC,KAAK,QAAU,GAAI,cAAa,WAEhC,KAAK,aAAe,GAAI,cAAa,YACrC,KAAK,aAAa,eAAe,gCACjC,KAAK,QAAQ,eAAe,KAAK,cAMjC,KAAM,GAAQ,GAAI,OAAM,MACxB,EAAM,IACJ,GAAI,OAAM,KACR,GAAI,OAAM,YAAY,EAAG,EAAG,GAC5B,GAAI,OAAM,kBAAkB,CAAE,MAAO,cAGzC,KAAK,cAAgB,CACnB,MAAO,EACP,WAAY,GACZ,QAAS,GACT,OAAQ,GACR,MAAO,GACP,SAAU,GAEV,OAAQ,OAUd,aAAa,EAAiC,CAC5C,KAAK,WAAa,EAYpB,WACE,EACA,EACM,CAEN,KAAM,GAAmB,AADP,KAAK,WACY,OAAO,SAAU,EAAU,CAC5D,MAAO,GAAS,OAAS,YAE3B,GAAI,EAAiB,SAAW,GAAK,CAAC,KAAK,QACzC,MAAO,GAAW,EAAiB,QAGrC,GAAI,GAAS,EACb,OAAS,GAAI,EAAG,EAAI,EAAiB,OAAQ,EAAE,EAAG,CAChD,KAAM,GAAW,EAAiB,GAC5B,EAAM,KAAK,iBAAiB,WAAW,EAAS,MAEtD,KAAK,QAAQ,gBAAkB,KAAK,iBAAiB,2BACnD,GAEF,KAAK,QAAQ,KACX,EACA,AAAC,GAA4B,CAC3B,KAAK,mBAAmB,IAAI,EAAS,KAAM,GAE3C,IACA,AAAI,IAAW,EAAiB,OAC9B,EAAW,EAAiB,QAE5B,EAAW,EAAQ,EAAiB,SAGxC,OACA,AAAC,GAAU,CACT,EAAO,MAAM,GAEb,IACA,AAAI,IAAW,EAAiB,OAC9B,EAAW,EAAiB,QAE5B,EAAW,EAAQ,EAAiB,WAe9C,SAAS,EAAyC,CAChD,MAAO,MAAK,mBAAmB,IAAI,IAAiB,KAAK,eAnItD,EAAM,mBATL",
  "names": []
}
